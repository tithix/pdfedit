<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Éditeur PDF: nanou</title>
  <link rel="icon" type="image/png" href="https://images-eds-ssl.xboxlive.com/image?url=4rt9.lXDC4H_93laV1_eHM0OYfiFeMI2p9MWie0CvL99U4GA1gf6_kayTt_kBblFwHwo8BW8JXlqfnYxKPmmBQ8Wp.b5steQR.trnLQy3OMj4iTSyuckh94uIuGibVHcGT1gWAOcIk6K5kLVtX.hmvbY1Feewq6T865JKSW00Pc-&format=source" onerror="console.error('Erreur de chargement du favicon:', this.href)">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.min.js"></script>
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    .cursor-text { cursor: text; }
    .highlight { background-color: yellow; }
    canvas {
      border: none;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    #canvas-container {
      position: relative;
      width: 100%; /* Assure que le conteneur prend toute la largeur disponible */
    }
    #tempInput {
      position: absolute;
      border: 1px solid #e5e7eb;
      background: white;
      font-family: 'Inter', sans-serif;
      font-size: 18px;
      outline: none;
      padding: 4px;
      z-index: 1000;
    }
    .interactive-button {
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .interactive-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    .interactive-button:active {
      transform: translateY(0);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    .header-icon {
      width: 40px;
      height: 40px;
      margin-right: 12px;
    }
    #instructions-modal {
      z-index: 2000;
    }
    .modal-content {
      max-width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .close-button {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background-color 0.3s ease;
    }
    .close-button:hover {
      background-color: #f3f4f6;
    }
  </style>
</head>
<body class="bg-gray-50">
  <div class="p-6 max-w-5xl mx-auto">
    <div class="flex items-center justify-center mb-6 space-x-3">
      <img src="https://images-eds-ssl.xboxlive.com/image?url=4rt9.lXDC4H_93laV1_eHM0OYfiFeMI2p9MWie0CvL99U4GA1gf6_kayTt_kBblFwHwo8BW8JXlqfnYxKPmmBQ8Wp.b5steQR.trnLQy3OMj4iTSyuckh94uIuGibVHcGT1gWAOcIk6K5kLVtX.hmvbY1Feewq6T865JKSW00Pc-&format=sourc" alt="Icône Éditeur PDF" class="header-icon" onerror="console.error('Erreur de chargement de l\'icône:', this.src)">
      <h1 class="text-3xl font-semibold text-gray-800">Éditeur PDF</h1>
      <span class="text-sm text-gray-500">Powered by NaNou</span>
    </div>
    <div class="flex flex-col space-y-6">
      <input type="file" id="pdfInput" accept="application/pdf" class="border-none p-4 text-base rounded-xl w-full bg-white shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none">
      <div class="flex flex-col space-y-6">
        <div class="flex flex-wrap gap-6 justify-center">
          <div class="flex flex-col items-center rounded-xl p-6 bg-white shadow-md">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">Tailles</h2>
            <div class="flex gap-2">
              <button onclick="changeSize(14)" class="interactive-button bg-blue-600 text-white px-4 py-2 text-base rounded-xl">14</button>
              <button onclick="changeSize(16)" class="interactive-button bg-blue-600 text-white px-4 py-2 text-base rounded-xl">16</button>
              <button onclick="changeSize(18)" class="interactive-button bg-blue-600 text-white px-4 py-2 text-base rounded-xl">18</button>
              <button onclick="changeSize(20)" class="interactive-button bg-blue-600 text-white px-4 py-2 text-base rounded-xl">20</button>
            </div>
          </div>
          <div class="flex flex-col items-center rounded-xl p-6 bg-white shadow-md">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">Couleurs</h2>
            <div class="flex gap-2">
              <button onclick="changeColor('#000000')" class="interactive-button bg-gray-800 text-white px-4 py-2 text-base rounded-xl">Noir</button>
              <button onclick="changeColor('#FF0000')" class="interactive-button bg-red-600 text-white px-4 py-2 text-base rounded-xl">Rouge</button>
              <button onclick="changeColor('#0000FF')" class="interactive-button bg-blue-800 text-white px-4 py-2 text-base rounded-xl">Bleu</button>
            </div>
          </div>
          <div class="flex flex-col items-center rounded-xl p-6 bg-white shadow-md">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">Divers</h2>
            <div class="flex justify-center">
              <button onclick="openInstructions()" class="interactive-button bg-purple-600 text-white px-4 py-2 text-base rounded-xl">À lire</button>
            </div>
          </div>
        </div>
        <div class="flex gap-3 justify-center">
          <button onclick="deleteAnnotation()" class="interactive-button bg-red-600 text-white px-4 py-2 text-base rounded-xl">Effacer</button>
          <button onclick="exportPDF()" class="interactive-button bg-green-600 text-white px-4 py-2 text-base rounded-xl">Exporter PDF</button>
        </div>
      </div>
    </div>
    <div id="canvas-container" class="mt-6">
      <canvas id="pdf-canvas" class="cursor-text mx-auto"></canvas>
    </div>
  </div>

  <!-- Modale pour les instructions -->
  <div id="instructions-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center">
    <div class="modal-content bg-white p-8 rounded-xl shadow-lg relative max-w-lg">
      <button onclick="closeInstructions()" class="close-button absolute top-4 right-4 text-gray-600 hover:text-gray-800">
        <span class="text-2xl">×</span>
      </button>
      <h2 class="text-2xl font-semibold mb-6 text-center text-purple-600">Comment utiliser l’Éditeur PDF</h2>
      <div class="text-gray-700 text-base space-y-4">
        <p>Salut ! Voici comment jouer avec cet outil pour modifier un PDF. C’est super facile !</p>
        <p><strong>1. Mets un PDF</strong><br>
        Clique sur la boîte en haut qui dit "Choisir un fichier". Cherche un PDF sur ton ordinateur et clique dessus. Tu vas voir le PDF apparaître en bas.</p>
        <p><strong>2. Écris quelque chose</strong><br>
        Clique sur le PDF là où tu veux écrire. Une petite boîte va apparaître. Tape ton mot ou ta phrase dedans, et appuie sur la touche "Entrer" de ton clavier pour le garder. Si tu changes d’avis, appuie sur "Échap" pour annuler.</p>
        <p><strong>3. Change la taille du texte</strong><br>
        Clique sur ton texte pour le choisir (il deviendra jaune). Ensuite, clique sur un bouton dans "Tailles" (14, 16, 18, ou 20) pour rendre ton texte plus petit ou plus grand.</p>
        <p><strong>4. Change la couleur</strong><br>
        Clique sur ton texte pour le choisir, puis clique sur une couleur dans "Couleurs" (Noir, Rouge, ou Bleu) pour changer sa couleur.</p>
        <p><strong>5. Déplace ton texte</strong><br>
        Clique sur ton texte, tiens le clic, et bouge ta souris pour le mettre ailleurs. Relâche quand c’est bien placé.</p>
        <p><strong>6. Efface un texte</strong><br>
        Clique sur le texte que tu veux enlever, puis clique sur le bouton "Effacer". Pof, il disparaît !</p>
        <p><strong>7. Garde ton PDF</strong><br>
        Quand tu as fini, clique sur "Exporter PDF". Ça va télécharger ton PDF avec tout ce que tu as écrit dessus.</p>
        <p>Amuse-toi bien !</p>
      </div>
    </div>
  </div>

  <script>
    const canvas = document.getElementById('pdf-canvas');
    const ctx = canvas.getContext('2d');
    const pdfInput = document.getElementById('pdfInput');
    const canvasContainer = document.getElementById('canvas-container');
    let annotations = [];
    let selectedAnnotation = null;
    let pdfDoc = null;
    let originalBytes = null;
    let pageHeight = 842; // Hauteur par défaut (A4)
    let scale = 1; // Échelle initiale, sera ajustée dynamiquement
    let tempInput = null;
    let isDragging = false;
    let isRendering = false;
    let clickTimeout = null;
    let originalFileName = ''; // Variable pour stocker le nom du fichier initial

    // Charger le PDF et ajuster dynamiquement l'échelle
    pdfInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      // Stocker le nom du fichier initial
      originalFileName = file.name;
      const arrayBuffer = await file.arrayBuffer();
      originalBytes = arrayBuffer;
      pdfDoc = await pdfjsLib.getDocument(arrayBuffer).promise;

      const page = await pdfDoc.getPage(1);
      const defaultViewport = page.getViewport({ scale: 1 }); // Échelle de 1 pour obtenir la largeur native
      const pdfWidth = defaultViewport.width; // Largeur native du PDF

      // Calculer l'échelle en fonction de la largeur du conteneur
      const containerWidth = canvasContainer.clientWidth;
      scale = containerWidth / pdfWidth; // Ajuster l'échelle pour que le PDF rentre dans le conteneur

      const viewport = page.getViewport({ scale });
      pageHeight = page.view[3]; // Hauteur réelle

      canvas.width = viewport.width;
      canvas.height = viewport.height;

      page.render({
        canvasContext: ctx,
        viewport: viewport,
      }).promise.then(() => drawAnnotations());
    });

    // Créer un champ de saisie temporaire pour écrire directement
    function createTempInput(x, y) {
      if (tempInput) tempInput.remove();
      tempInput = document.createElement('input');
      tempInput.id = 'tempInput';
      tempInput.style.left = `${x}px`;
      tempInput.style.top = `${y}px`;
      canvasContainer.appendChild(tempInput);
      tempInput.focus();

      tempInput.addEventListener('input', () => {
        drawAnnotations();
        ctx.font = `18px 'Inter', sans-serif`; // Taille et police ajustées
        ctx.fillStyle = '#000000';
        ctx.fillText(tempInput.value, x / scale, (pageHeight - y / scale) * scale);
      });

      tempInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          const text = tempInput.value.trim();
          if (text) {
            annotations.push({ text, x: x / scale, y: pageHeight - y / scale, size: 16, color: '#000000' });
          }
          tempInput.remove();
          tempInput = null;
          drawAnnotations();
        } else if (e.key === 'Escape') {
          tempInput.remove();
          tempInput = null;
          drawAnnotations();
        }
      });
    }

    // Détecter si la souris est au-dessus d'une annotation
    function isMouseOverAnnotation(mouseX, mouseY) {
      return annotations.find(ann => {
        const canvasX = ann.x * scale;
        const canvasY = (pageHeight - ann.y) * scale;
        ctx.font = `${ann.size * scale}px 'Inter', sans-serif`;
        const textWidth = ctx.measureText(ann.text).width;
        const textHeight = ann.size * scale;
        return (
          mouseX >= canvasX &&
          mouseX <= canvasX + textWidth &&
          mouseY >= canvasY - textHeight &&
          mouseY <= canvasY
        );
      });
    }

    // Gérer le clic simple sur le canvas
    function handleCanvasClick(e) {
      if (clickTimeout) clearTimeout(clickTimeout);

      clickTimeout = setTimeout(() => {
        const rect = canvas.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;

        // Vérifier si le clic est sur une annotation existante
        selectedAnnotation = isMouseOverAnnotation(mouseX, mouseY);

        if (!selectedAnnotation) {
          // Pas d'annotation sélectionnée, créer un champ de saisie
          createTempInput(mouseX, mouseY);
        }
        drawAnnotations();
      }, 200); // Délai pour différencier clic simple et double-clic
    }

    // Gérer le double-clic sur le canvas
    function handleCanvasDoubleClick(e) {
      clearTimeout(clickTimeout); // Annuler le clic simple

      const rect = canvas.getBoundingClientRect();
      const mouseX = e.clientX - rect.left;
      const mouseY = e.clientY - rect.top;

      // Vérifier si le double-clic est sur une annotation existante
      selectedAnnotation = isMouseOverAnnotation(mouseX, mouseY);

      if (selectedAnnotation) {
        // Surligner l'annotation pour indiquer qu'elle est en mode "modifier"
        drawAnnotations();
      }
    }

    // Gérer le survol pour changer le curseur
    function handleMouseMove(e) {
      const rect = canvas.getBoundingClientRect();
      const mouseX = e.clientX - rect.left;
      const mouseY = e.clientY - rect.top;

      // Vérifier si la souris est au-dessus de l'annotation surlignée
      if (selectedAnnotation && isMouseOverAnnotation(mouseX, mouseY) === selectedAnnotation) {
        canvas.style.cursor = 'pointer';
      } else {
        canvas.style.cursor = 'text';
      }

      // Gérer le déplacement si en mode drag
      if (isDragging && selectedAnnotation) {
        selectedAnnotation.x = mouseX / scale;
        selectedAnnotation.y = pageHeight - (mouseY / scale);
        drawAnnotations();
      }
    }

    // Gérer le début du déplacement
    function handleMouseDown(e) {
      const rect = canvas.getBoundingClientRect();
      const mouseX = e.clientX - rect.left;
      const mouseY = e.clientY - rect.top;

      // Vérifier si le clic est sur une annotation surlignée
      if (selectedAnnotation && isMouseOverAnnotation(mouseX, mouseY) === selectedAnnotation) {
        isDragging = true;
      }
    }

    // Arrêter le déplacement
    function handleMouseUp() {
      isDragging = false;
    }

    // Dessiner toutes les annotations
    function drawAnnotations() {
      if (!pdfDoc) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        return;
      }

      if (isRendering) return;
      isRendering = true;

      pdfDoc.getPage(1).then(page => {
        const viewport = page.getViewport({ scale });
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        page.render({
          canvasContext: ctx,
          viewport: viewport,
        }).promise.then(() => {
          annotations.forEach(ann => {
            const canvasX = ann.x * scale;
            const canvasY = (pageHeight - ann.y) * scale;
            ctx.font = `${ann.size * scale}px 'Inter', sans-serif`;
            if (ann === selectedAnnotation) {
              ctx.fillStyle = 'yellow';
              ctx.fillRect(canvasX, canvasY - ann.size * scale, ctx.measureText(ann.text).width, ann.size * scale);
            }
            ctx.fillStyle = ann.color;
            ctx.fillText(ann.text, canvasX, canvasY);
          });
          isRendering = false;
        }).catch(err => {
          console.error("Erreur lors du rendu:", err);
          isRendering = false;
        });
      }).catch(err => {
        console.error("Erreur lors de la récupération de la page:", err);
        isRendering = false;
      });
    }

    // Modifier la taille
    function changeSize(newSize) {
      if (selectedAnnotation) {
        selectedAnnotation.size = newSize;
        drawAnnotations();
      }
    }

    // Modifier la couleur
    function changeColor(newColor) {
      if (selectedAnnotation) {
        selectedAnnotation.color = newColor;
        drawAnnotations();
      }
    }

    // Effacer l'annotation sélectionnée
    function deleteAnnotation() {
      if (selectedAnnotation) {
        annotations = annotations.filter(ann => ann !== selectedAnnotation);
        selectedAnnotation = null;
        drawAnnotations();
      }
    }

    // Exporter le PDF modifié avec un nom personnalisé
    async function exportPDF() {
      if (!originalBytes) {
        console.error("Aucun PDF chargé pour l'exportation");
        return;
      }

      try {
        const pdfDoc = await PDFLib.PDFDocument.load(originalBytes);
        const page = pdfDoc.getPage(0); // Page 1
        const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);

        annotations.forEach(ann => {
          console.log("Exportation de l'annotation:", ann);
          const rgb = hexToRgb(ann.color);
          page.drawText(ann.text, {
            x: ann.x,
            y: ann.y,
            size: ann.size,
            font: font,
            color: PDFLib.rgb(rgb.r, rgb.g, rgb.b),
          });
        });

        const pdfBytes = await pdfDoc.save();
        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);

        // Construire le nom du fichier exporté : "édité-(nom initial).pdf"
        let exportFileName = 'edited.pdf'; // Nom par défaut
        if (originalFileName) {
          // Retirer l'extension .pdf si elle existe
          const baseName = originalFileName.toLowerCase().endsWith('.pdf')
            ? originalFileName.slice(0, -4)
            : originalFileName;
          exportFileName = `édité-${baseName}.pdf`;
        }
        link.download = exportFileName;

        link.click();
      } catch (error) {
        console.error("Erreur lors de l'exportation du PDF:", error);
      }
    }

    // Convertir hex en RGB
    function hexToRgb(hex) {
      const r = parseInt(hex.slice(1, 3), 16) / 255;
      const g = parseInt(hex.slice(3, 5), 16) / 255;
      const b = parseInt(hex.slice(5, 7), 16) / 255;
      return { r, g, b };
    }

    // Fonctions pour ouvrir et fermer la modale
    function openInstructions() {
      document.getElementById('instructions-modal').classList.remove('hidden');
    }

    function closeInstructions() {
      document.getElementById('instructions-modal').classList.add('hidden');
    }

    // Événements
    canvas.addEventListener('click', handleCanvasClick);
    canvas.addEventListener('dblclick', handleCanvasDoubleClick);
    canvas.addEventListener('mousemove', handleMouseMove);
    canvas.addEventListener('mousedown', handleMouseDown);
    canvas.addEventListener('mouseup', handleMouseUp);
  </script>
</body>
</html>
